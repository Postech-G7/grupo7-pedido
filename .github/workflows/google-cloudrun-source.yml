name: 'Deploy GCP'

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 'Check out repository'
        uses: 'actions/checkout@v4'

      - name: 'Set up Node.js'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20.x'

      - name: 'Install dependencies'
        run: 'npm install'

      - name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.CI_CD_GCP_POSTECH_GRUPO7 }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
        with:
          project_id: 'storied-imprint-441522-s7'

      - name: 'Configure Docker'
        run: gcloud auth configure-docker --quiet

      - name: 'Build Docker image'
        run: docker build -t gcr.io/storied-imprint-441522-s7/pedido:latest .

      - name: 'Push Docker image'
        run: docker push gcr.io/storied-imprint-441522-s7/pedido:latest

      - name: 'Deploy to Cloud Run'
        run: gcloud run deploy pedido-backend --image gcr.io/storied-imprint-441522-s7/pedido:latest --region us-central1 --platform managed --allow-unauthenticated
        env:
          NODE_ENV: 'production'
          DATABASE_URL: '${{ secrets.DATABASE_URL }}'
          API_KEY: '${{ secrets.API_KEY }}'
          MERCADOPAGO_USERID: "${{ secrets.MERCADOPAGO_USERID }}"
          MERCADO_PAGO_TOKEN: "${{ secrets.MERCADO_PAGO_TOKEN }}"
          MERCADO_PAGO_POS_ID: "${{ secrets.MERCADO_PAGO_POS_ID }}"
          MERCADO_PAGO_WEBHOOK_URL: "	https://webhook.site/b19c73a2-d53c-445f-9ccb-4289685a38c1"